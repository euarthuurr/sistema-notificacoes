
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel - Sistema de NotificaÃ§Ãµes de PendÃªncias DCAR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar px-3">
    <span class="navbar-brand">
        <img src="/detran-roraima.png" alt="Logo" class="navbar-logo">
        <span>Sistema de NotificaÃ§Ãµes de PendÃªncias DCAR</span>
    </span>
    <div class="d-flex align-items-center">
      <button id="logoutBtn" class="btn btn-danger">Sair</button>
      <button class="theme-toggler" id="themeToggler">ğŸŒ™</button>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-md-4" id="area-funcionario">
        <h4>ğŸ“Œ Criar PendÃªncia</h4>
        <form id="pendenciaForm">
          <div class="mb-3">
            <label for="placa" class="form-label">Placa (exatamente 7 caracteres)</label>
            <input type="text" class="form-control" id="placa" required maxlength="7" pattern=".{7,7}" title="A placa deve ter exatamente 7 caracteres." oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
          </div>
          <div class="mb-3">
            <label for="descricao" class="form-label">DescriÃ§Ã£o (Opcional)</label>
            <textarea class="form-control" id="descricao"></textarea>
          </div>
          <div class="mb-3">
            <label for="despachante" class="form-label">Atribuir ao Despachante</label>
            <select class="form-select" id="despachante" required>
                <option value="" disabled selected>Carregando...</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Enviar PendÃªncia</button>
        </form>
      </div>

      <div class="col-md-8">
        <h4>ğŸ”” NotificaÃ§Ãµes</h4>
        
        <div class="stat-card-container">
            <div id="filter-all" class="stat-card active">Todos: <span id="count-all">0</span></div>
            <div id="filter-pendente" class="stat-card">Pendentes: <span id="count-pendente">0</span></div>
            <div id="filter-resolvido" class="stat-card">Resolvidos: <span id="count-resolvido">0</span></div>
        </div>

        <div id="notificacoes" class="row"></div>
      </div>
    </div>
  </div>

  <footer>
    desenvolvido por AAâ„¢
  </footer>

<script>
const themeToggler = document.getElementById('themeToggler');
function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); themeToggler.innerHTML = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'; }
themeToggler.addEventListener('click', () => { const currentTheme = document.documentElement.getAttribute('data-theme'); setTheme(currentTheme === 'dark' ? 'light' : 'dark'); });
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
if (savedTheme) { setTheme(savedTheme); } else if (prefersDark) { setTheme('dark'); } else { setTheme('light'); }

let ws;
let currentUser = null;
let allPendencias = [];
let currentFilter = 'all';

function copyToClipboard(button, text) { navigator.clipboard.writeText(text).then(() => { const originalText = button.textContent; button.textContent = 'Copiado!'; setTimeout(() => { button.textContent = originalText; }, 1500); }).catch(err => console.error('Failed to copy text: ', err)); }
function formatDate(dateString) { if (!dateString) return 'N/A'; return new Date(dateString).toLocaleString('pt-BR'); }

async function loadDespachantes() { try { const res = await fetch('/api/despachantes'); const { despachantes } = await res.json(); const select = document.getElementById('despachante'); select.innerHTML = '<option value="" disabled selected>Selecione um despachante</option>'; despachantes.forEach(d => { const option = document.createElement('option'); option.value = d.id; option.textContent = d.nome; select.appendChild(option); }); } catch (err) { console.error('Failed to load despachantes', err); } }

async function init() {
  try {
    const sessionRes = await fetch('/api/session');
    if (!sessionRes.ok) throw new Error('Not authenticated');
    const { user } = await sessionRes.json();
    currentUser = user;

    if (currentUser.tipo === 'funcionario') { loadDespachantes(); } 
    else { document.getElementById('area-funcionario').style.display = 'none'; }

    ws = new WebSocket(`ws://${window.location.host}`);
    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'error') { alert(msg.message); }
        else if (msg.type === 'update' || msg.type === 'initialPendencias') { allPendencias = msg.pendencias; renderNotifications(); }
    };
  } catch (err) { window.location.href = '/'; }
}

function renderNotifications() {
  const container = document.getElementById('notificacoes');
  container.innerHTML = '';

  const countPendente = allPendencias.filter(p => p.status === 'pendente').length;
  const countResolvido = allPendencias.filter(p => p.status === 'resolvido').length;
  document.getElementById('count-all').textContent = allPendencias.length;
  document.getElementById('count-pendente').textContent = countPendente;
  document.getElementById('count-resolvido').textContent = countResolvido;

  const filteredPendencias = allPendencias.filter(p => currentFilter === 'all' || p.status === currentFilter);

  if (filteredPendencias.length === 0) { container.innerHTML = '<p class="text-center col-12">Nenhuma notificaÃ§Ã£o encontrada.</p>'; return; }

  filteredPendencias.forEach(p => {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-3';
    const card = document.createElement('div');
    card.className = 'notification-card h-100 ';
    card.classList.add(p.status === 'pendente' ? 'notification-pendente' : 'notification-resolvido');
    
    let actionButtons = '';
    if (currentUser.tipo === 'despachante') {
        if (p.status === 'pendente') { actionButtons += `<button class="btn btn-light btn-sm mt-2" onclick="changeStatus(${p.id}, 'resolver')">âœ”ï¸ Marcar como Resolvido</button>`; }
        else { actionButtons += `<button class="btn btn-light btn-sm mt-2" onclick="changeStatus(${p.id}, 'pendente')">â†©ï¸ Marcar como Pendente</button>`; }
    }
    if (currentUser.tipo === 'funcionario') {
        actionButtons += `<button class="btn btn-warning btn-sm mt-2 ms-1" onclick="changeStatus(${p.id}, 'triar')">ğŸ“ Arquivar (Triar)</button>`;
    }

    card.innerHTML = `
        <div class="plate-highlight">${p.placa}</div>
        <button class="btn btn-secondary btn-sm py-0" onclick="copyToClipboard(this, '${p.placa}')">Copiar Placa</button><hr>
        <strong>ğŸ“„ DescriÃ§Ã£o:</strong> ${p.descricao || '<em>Sem descriÃ§Ã£o</em>'}<br>
        <strong>ğŸ‘¤ Criado por:</strong> ${p.criador_nome}<br>
        <strong>ğŸ™‹â€â™‚ï¸ Para:</strong> ${p.despachante_nome}<br>
        <small><strong>Criado em:</strong> ${formatDate(p.criado_em)}</small><br>
        ${p.status === 'resolvido' ? `<small><strong>Resolvido em:</strong> ${formatDate(p.resolvido_em)}</small><br>` : ''}
        <strong>Status:</strong> ${p.status}<br>
        ${actionButtons}
    `;
    col.appendChild(card);
    container.appendChild(col);
  });
}

function setFilter(filter) { currentFilter = filter; document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active')); document.getElementById(`filter-${filter}`).classList.add('active'); renderNotifications(); }

document.getElementById('filter-all').addEventListener('click', () => setFilter('all'));
document.getElementById('filter-pendente').addEventListener('click', () => setFilter('pendente'));
document.getElementById('filter-resolvido').addEventListener('click', () => setFilter('resolvido'));

function changeStatus(id, newStatus) { if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: newStatus, pendenciaId: id })); } }

document.getElementById('pendenciaForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) return;
  const placa = document.getElementById('placa').value;
  const descricao = document.getElementById('descricao').value;
  const despachante_id = document.getElementById('despachante').value;
  if (!despachante_id) { alert('Por favor, selecione um despachante.'); return; }
  const res = await fetch('/api/pendencias', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ placa, descricao, criador_id: currentUser.id, despachante_id }) });
  if (res.ok) { document.getElementById('pendenciaForm').reset(); } else { alert('Erro ao criar pendÃªncia'); }
});

document.getElementById('logoutBtn').addEventListener('click', async () => { await fetch('/api/logout', { method: 'POST' }); window.location.href = '/'; });

init();
</script>
</body>
</html>
