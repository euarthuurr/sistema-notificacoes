<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel - Sistema de Notificações de Pendências DCAR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar px-3">
    <span class="navbar-brand">
        <img src="/detran-roraima.png" alt="Logo" class="navbar-logo">
        <span>Sistema de Notificações de Pendências DCAR</span>
    </span>
    <div class="d-flex align-items-center">
      <button id="changePasswordBtn" class="btn btn-warning me-2">Alterar Senha</button>
      <button id="logoutBtn" class="btn btn-danger">Sair</button>
      <button class="theme-toggler" id="themeToggler">🌙</button>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-md-4" id="area-funcionario">
        <h4>📌 Criar Pendência</h4>
        <form id="pendenciaForm">
          <div class="mb-3">
            <label for="placa" class="form-label">Placa (exatamente 7 caracteres)</label>
            <input type="text" class="form-control" id="placa" required maxlength="7" pattern=".{7,7}" title="A placa deve ter exatamente 7 caracteres." oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
          </div>
          <div class="mb-3">
            <label for="descricao" class="form-label">Descrição (Opcional)</label>
            <textarea class="form-control" id="descricao"></textarea>
          </div>
          <div class="mb-3">
            <label for="despachante" class="form-label">Atribuir ao Despachante</label>
            <select class="form-select" id="despachante" required>
                <option value="" disabled selected>Carregando...</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Enviar Pendência</button>
        </form>
      </div>

      <div class="col-md-8">
        <h4>🔔 Notificações</h4>
        
        <div class="stat-card-container">
            <div id="filter-all" class="stat-card active">Todos: <span id="count-all">0</span></div>
            <div id="filter-pendente" class="stat-card">Pendentes: <span id="count-pendente">0</span></div>
            <div id="filter-resolvido" class="stat-card">Resolvidos: <span id="count-resolvido">0</span></div>
        </div>

        <div id="notificacoes" class="row"></div>
      </div>
    </div>
  </div>

  <!-- Reopen Pendencia Modal (for Funcionarios) -->
  <div class="modal fade" id="reopenModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Reabrir Pendência</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="reopenForm">
            <input type="hidden" id="reopenPendenciaId">
            <div class="mb-3"><label for="reopenDescricao" class="form-label">Nova Descrição (ou mantenha a atual)</label><textarea class="form-control" id="reopenDescricao" rows="4"></textarea></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="reopenPendenciaBtn">Reabrir</button></div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Alterar Senha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="mb-3">
              <label for="oldPassword" class="form-label">Senha Antiga</label>
              <input type="password" class="form-control" id="oldPassword" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nova Senha</label>
              <input type="password" class="form-control" id="newPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" id="savePasswordBtn">Salvar Nova Senha</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    desenvolvido por AA™
  </footer>

<script>
const themeToggler = document.getElementById('themeToggler');
function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    themeToggler.innerHTML = theme === 'dark' ? '☀️' : '🌙';
}
themeToggler.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    setTheme(currentTheme === 'dark' ? 'light' : 'dark');
});
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
if (savedTheme) { setTheme(savedTheme); } else if (prefersDark) { setTheme('dark'); } else { setTheme('light'); }

let ws;
let currentUser = null;
let allPendencias = [];
let currentFilter = 'all';
let reopenModal;
let changePasswordModal;

function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copiado!';
        setTimeout(() => { button.textContent = originalText; }, 1500);
    }).catch(err => console.error('Failed to copy text: ', err));
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleString('pt-BR');
}

async function loadDespachantes() {
    try {
        const res = await fetch('/api/despachantes', { credentials: 'include' });
        const { despachantes } = await res.json();
        const select = document.getElementById('despachante');
        select.innerHTML = '<option value="" disabled selected>Selecione um despachante</option>';
        despachantes.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id;
            option.textContent = d.nome;
            select.appendChild(option);
        });
    } catch (err) { console.error('Failed to load despachantes', err); }
}

async function init() {
  try {
    reopenModal = new bootstrap.Modal(document.getElementById('reopenModal'));
    changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));

    const sessionRes = await fetch('/api/session', { credentials: 'include' });
    if (!sessionRes.ok) throw new Error('Not authenticated');
    const { user } = await sessionRes.json();
    currentUser = user;

    if (currentUser.tipo === 'funcionario') {
        loadDespachantes();
    } else {
        document.getElementById('area-funcionario').style.display = 'none';
    }

    ws = new WebSocket(`ws://${window.location.host}`);
    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'error') {
            alert(msg.message);
        } else if (msg.type === 'update' || msg.type === 'initialPendencias') {
            allPendencias = msg.pendencias;
            renderNotifications();
        }
    };
  } catch (err) { window.location.href = '/'; }
}

function renderNotifications() {
  const container = document.getElementById('notificacoes');
  container.innerHTML = '';

  const countPendente = allPendencias.filter(p => p.status === 'pendente').length;
  const countResolvido = allPendencias.filter(p => p.status === 'resolvido').length;
  document.getElementById('count-all').textContent = allPendencias.length;
  document.getElementById('count-pendente').textContent = countPendente;
  document.getElementById('count-resolvido').textContent = countResolvido;

  const filteredPendencias = allPendencias.filter(p => currentFilter === 'all' || p.status === currentFilter);

  if (filteredPendencias.length === 0) {
      container.innerHTML = '<p class="text-center col-12">Nenhuma notificação encontrada.</p>';
      return;
  }

  filteredPendencias.forEach(p => {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-3';
    const card = document.createElement('div');
    card.className = 'notification-card h-100 ';
    card.classList.add(p.status === 'pendente' ? 'notification-pendente' : 'notification-resolvido');
    
    let actionButtons = '';
    if (currentUser.tipo === 'despachante') {
        if (p.status === 'pendente') { actionButtons += `<button class="btn btn-light btn-sm mt-2" onclick="changeStatus(${p.id}, 'resolver')">✔️ Marcar como Resolvido</button>`; }
        else { actionButtons += `<button class="btn btn-light btn-sm mt-2" onclick="changeStatus(${p.id}, 'pendente')">↩️ Marcar como Pendente</button>`; }
    }
    if (currentUser.tipo === 'funcionario') {
        if (p.status === 'resolvido') {
            actionButtons += `<button class="btn btn-info btn-sm mt-2 ms-1" onclick="showReopenModal(${p.id}, '${p.descricao.replace(/'/g, "\\'")}')">↩️ Reabrir Pendência</button>`;
        }
    }

    const creatorLine = currentUser.tipo !== 'despachante' 
        ? `<strong>👤 Criado por:</strong> ${p.criador_nome}<br>` 
        : '<strong>👤 Criado por:</strong> Detran<br>';

    card.innerHTML = `
        <div class="plate-highlight">${p.placa}</div>
        <button class="btn btn-secondary btn-sm py-0" onclick="copyToClipboard(this, '${p.placa}')">Copiar Placa</button><hr>
        <strong>📄 Descrição:</strong> ${p.descricao || '<em>Sem descrição</em>'}<br>
        ${creatorLine}
        <strong>🙋‍♂️ Para:</strong> ${p.despachante_nome}<br>
        <small><strong>Criado em:</strong> ${formatDate(p.criado_em)}</small><br>
        ${p.status === 'resolvido' ? `<small><strong>Resolvido em:</strong> ${formatDate(p.resolvido_em)}</small><br>` : ''}
        <strong>Status:</strong> ${p.status}<br>
        ${actionButtons}
    `;
    col.appendChild(card);
    container.appendChild(col);
  });
}

function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
    document.getElementById(`filter-${filter}`).classList.add('active');
    renderNotifications();
}

document.getElementById('filter-all').addEventListener('click', () => setFilter('all'));
document.getElementById('filter-pendente').addEventListener('click', () => setFilter('pendente'));
document.getElementById('filter-resolvido').addEventListener('click', () => setFilter('resolvido'));

function changeStatus(id, newStatus) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: newStatus, pendenciaId: id }));
    }
}

function showReopenModal(id, currentDescription) {
    document.getElementById('reopenPendenciaId').value = id;
    document.getElementById('reopenDescricao').value = currentDescription;
    reopenModal.show();
}

document.getElementById('reopenPendenciaBtn').addEventListener('click', () => {
    const id = document.getElementById('reopenPendenciaId').value;
    const newDescription = document.getElementById('reopenDescricao').value;
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'reabrir', pendenciaId: id, descricao: newDescription }));
    }
    reopenModal.hide();
});

document.getElementById('pendenciaForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) return;
  const placa = document.getElementById('placa').value;
  const descricao = document.getElementById('descricao').value;
  const despachante_id = document.getElementById('despachante').value;
  if (!despachante_id) { alert('Por favor, selecione um despachante.'); return; }
  const res = await fetch('/api/pendencias', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ placa, descricao, criador_id: currentUser.id, despachante_id }),
    credentials: 'include'
  });
  if (res.ok) { document.getElementById('pendenciaForm').reset(); } 
  else { alert('Erro ao criar pendência'); }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await fetch('/api/logout', { method: 'POST', credentials: 'include' });
  window.location.href = '/';
});

document.getElementById('changePasswordBtn').addEventListener('click', () => {
    document.getElementById('changePasswordForm').reset();
    changePasswordModal.show();
});

document.getElementById('savePasswordBtn').addEventListener('click', async () => {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    if (!oldPassword || !newPassword) {
        alert('Por favor, preencha todos os campos.');
        return;
    }
    try {
        const res = await fetch('/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ oldPassword, newPassword }),
            credentials: 'include'
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Falha ao alterar a senha');
        }
        changePasswordModal.hide();
        alert('Senha alterada com sucesso!');
    } catch (e) {
        alert(e.message);
    }
});

init();
</script>
</body>
</html>